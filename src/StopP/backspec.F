	PROGRAM BACK_SPEC
 
C	CALCOLA LO SPETTRO DI PARTICELLA ALL'INDIETRO
C	STOPPING POWERS CALCOLATI DA ZIEGLER

	LOGICAL INP_QUOTE
	REAL MBNP,MASS1,MASS2,MASS3,MASS4,MASS12,MASS34
	INTEGER*4 ZPROJ,ZTARG,ZREC,ZLIGHT
	INTEGER*4 APROJ,ATARG,AREC,ALIGHT
	DIMENSION DENARR(2),NATOMS(2),THICK(2),CTHICK(2)
	DIMENSION ZARR(20,2),AARR(20,2),ANARR(20,2)
	CHARACTER*10 NAMTAR,NAMARR,NAMNUCL*2
	CHARACTER*40 LINE

	DIMENSION SPEK(0:2047),ESPEK(0:2047)
	DIMENSION SECT(1000),ESECT(1000)
	CHARACTER*40 CFNAM		/'CROSSSECT.INP'/
	CHARACTER*40 FNOUT		/'BACKSPEC.DAT'/
	DATA ESCA/100./,EMIN/500./,CSECTC/10./,NORD/1/

	DATA CCMSEC/29979250000./		! c  (cm/sec)
	DATA XMNKEV/931478./			! Mn (keV)
	DATA PIGRE/3.141592654/			! pi greco
	DATA DEGRAD/57.29577951/		! 180/pigreco
	DATA ALN2/0.693147181/			! ln(2)
	DATA HTCSUE2/137./			! e2/h_c=1/137
	DATA XMUNSUHT/4798.4/			! muN/h_ (rad/Gauss/sec)

	DATA FACPT,FACLT,FACRT,FACRF/1.,1.,1.,1./
	DATA NATOMS /1,1/
	DATA NDIV,IHOST,IFIEL/100,0,0/
	DATA THMIND,THMAXD,DNNTH/140.,180.,2./

1	WRITE(6,'(//20X,
	1	'' Backscattering spectrum'',//,2X,''Reaction definition''/)')
 
C		  INPUT    REACTION
 
	ZPROJ=12
	APROJ=24
	CALL INP_I2('Z,A   of projectile : ',ZPROJ,APROJ)
	IF(ZPROJ.LE.0 .OR. APROJ.LE.0) GOTO 1
	CALL XMASS(ZPROJ,APROJ,XMASS1,DMASS1)
	MASS1=XMASS1/XMNKEV+APROJ
 
	ZTARG=82
	ATARG=208
	CALL INP_I2('Z,A   of target : ',ZTARG,ATARG)
	IF(ZTARG.LE.0. .OR. ATARG.LE.0) GOTO 1
	CALL XMASS(ZTARG,ATARG,XMASS2,DMASS2)
	MASS2=XMASS2/XMNKEV+ATARG
 
	ZREC=82
	AREC=208
	CALL INP_I2('Z,A   of recoil : ',ZREC,AREC)
	IF(ZREC.LE.0. .OR. AREC.LE.0) GOTO 1
	CALL XMASS(ZREC,AREC,XMASS4,DMASS4)
	MASS4=XMASS4/XMNKEV+AREC
 
	ZLIGHT=ZPROJ+ZTARG-ZREC
	ALIGHT=APROJ+ATARG-AREC
	IF(ZLIGHT.LT.0 .OR. ALIGHT.LT.0) GOTO 1
	CALL XMASS(ZLIGHT,ALIGHT,XMASS3,DMASS3)
	MASS3=XMASS3/XMNKEV+ALIGHT
 
	MASS12=MASS1+MASS2
	MASS34=MASS3+MASS4
	QVAL=XMASS1+XMASS2-(XMASS3+XMASS4)
	DQVAL=SQRT(DMASS1**2+DMASS2**2+DMASS4**2+DMASS3**2)
	WRITE(6,'(''  Q-value='',F10.2,''  keV'')') QVAL

	EXENER=1400
	CALL INP_R1('Excitation Energy (keV) : ',EXENER)
	QVALO=QVAL-EXENER

	CALL INP_R1('Angle for light particle (DEG.) : ',THMAXD)
	IF(THMAXD.GT.180.) THMAXD=180.
	IF(THMAXD.LT.0.) THMAXD=0.
	THMAX=THMAXD/DEGRAD
	THM=THMAX

C	 INPUT FOR TARGET

	NAMTAR='Piombo'
	CALL INP_CH('Target material symbol  ',NAMTAR)
	XX=NATOMS(1)
	DENARR(1)=11.34
	CALL INP_R2('Target density(g/cm3) [,#of different atoms] : ',
	1		DENARR(1),XX)
	IF(DENARR(1).LE.0.) GOTO 1
	IF(XX.EQ.1.) THEN
		NATOMS(1)=1
		ZARR(1,1)=ZTARG
		AARR(1,1)=ATARG
		ANARR(1,1)=1.
	ELSE
		NATOMS(1)=MIN(20.,MAX(1.,XX))
		LINE='Z, A, #atoms/molecule  for atom #    : '
		DO II=1,NATOMS(1)
		   WRITE(LINE(34:36),'(I3)') II
		   CALL INP_R3(LINE,ZARR(II,1),AARR(II,1),ANARR(II,1))
		   IF(ZARR(II,1).LE.0.) GOTO 1
		   IF(ANARR(II,1).LE.0.) ANARR(II,1)=1.
		ENDDO
	ENDIF

	XX=NDIV
	THICK(1)=20000
	XX=200
	CALL INP_R2('Target thickness{ >0==>mmg/cm2 <0==>micron }[,#step] : ',
	1	THICK(1),XX)
	IF(XX.LT.10) XX=10
	NDIV=XX
	IF(THICK(1).EQ.0.) GOTO 1
	IF(THICK(1).LT.0.) THICK(1)=-THICK(1)*DENARR(1)*100.
	CTHICK(1)=THICK(1)/DENARR(1)*1.0E-6

	EPROJ=130000
	CALL INP_R1('Projectile energy(keV) : ',EPROJ)
	IF(EPROJ.LE.0.) GOTO 1

	CALL INP_R1('Fattore per lo stopping del proj.  in targ.   : ',FACPT)
	IF(FACPT.LT.0) FACPT=1
	CALL INP_R1('Fattore per lo stopping del light  in targ.   : ',FACLT)
	IF(FACLT.LT.0) FACLT=1
	CALL INP_R1('Fattore per lo stopping del recoil in targ.   : ',FACRT)
	IF(FACRT.LT.0) FACRT=1

	IF(INP_QUOTE('Summary of stopping powers (Y/N) ? ')) THEN
		WRITE(6,6139)
6139	FORMAT(/' Energy(MeV)',5X,17('-'),' DEDX(keV/(mmg/cm2)) ',17('-'),/
	1	 18X,'Proj.-Targ.    Light-Targ.    Rec.-Targ.     Rec.-Ferr.')
		DO XXE=0,EPROJ,5000
			XX=XXE
			IF(XX.LT.1000) XX=1000
			SPW1=STPW(XX,ZPROJ,APROJ,NATOMS(1),
	1			ZARR(1,1),AARR(1,1),ANARR(1,1))*FACPT
			SPWL1=STPW(XX,ZLIGHT,ALIGHT,NATOMS(1),
	1			ZARR(1,1),AARR(1,1),ANARR(1,1))*FACLT
			SPW2=STPW(XX,ZREC,AREC,NATOMS(1),
	1			ZARR(1,1),AARR(1,1),ANARR(1,1))*FACRT
			WRITE(6,6141) XX/1000,SPW1,SPWL1,SPW2
6141			FORMAT(F11.3,2X,4F15.4)
		ENDDO
	ENDIF

	CALL INP_CH('File with cross section data ',CFNAM)
	OPEN(1,FILE=CFNAM,STATUS='OLD',READONLY,ERR=6940)

	II=1
6900	READ(1,*,END=6920,ERR=6920) ESECT(II),SECT(II)
	ESECT(II)=ESECT(II)*1000
	WRITE(6,*) II,ESECT(II),SECT(II)
	II=II+1
	GOTO 6900

6920	NSECT=II-1
	CLOSE(1)
	GOTO 6960

6940	WRITE(6,*) ' Cross section file not found'
	WRITE(6,*) ' Assuming costant cross section = ',CSECTC
	NSECT=0

6960	DO I=1,1024
		SPEK(I)=0.
		ESPEK(I)=0.
	ENDDO


	EPT=EPROJ		! COLLISIONE SUL FRONTE DEL TARGET
	ETOT=EPT+QVALO

	CALL CINEMA(MASS1,MASS2,MASS3,MASS4,QVALO,EPT,THM,
	1	ENED1,THU1,ENEU1,ENED2,THU2,ENEU2,THCMD1,THCMD2)

	IF(ENED1.LE.0 .AND. ENED2.LE.0) THEN
		THL=THM*DEGRAD
		WRITE(6,'(''  No light particle at '',F8.2,''  DEG.'')')THL
		GOTO 1
	ENDIF 

	IF(ENED1.GT.0 .AND. ENED2.GT.0) THEN
		WRITE(6,*) ' Kinematics with 2 solutions'
		GOTO 1
	ENDIF

	IF(ENED1.GT.0) THEN
		ELIGHT=ENED1
		ERECO=ENEU1
		CSI=THU1
	ELSE
		STOP ' ENED1=0'
	ENDIF
	ERLT=ELIGHT

	CSECT=CSECTC
	IF(NSECT.GT.NORD+1) CALL INTERPOL(NSECT,NORD,EPT,CSECT,ESECT,SECT)

	THL=THM*DEGRAD
	THR=CSI*DEGRAD
	WRITE(6,*)
	WRITE(6,625)
625	FORMAT(6X,
	1'mmg/cm2   Eproj(keV)   Erec(keV)  Eback(keV)      csect   Edet(keV)')

	WRITE(6,626) 0.,EPT,ERECO,ELIGHT,CSECT,ERLT
626	FORMAT(1X,F12.1,F12.1,F12.1,F12.1,F12.3,F12.1)

	DTHICK=THICK(1)/NDIV

	DO  IIDIV=1,NDIV
		EPTO=EPT
		ELIGHTO=ELIGHT
		ERLTO=ERLT

		TAR1=DTHICK*IIDIV
		TAR2=THICK(1)-TAR1

C	   PROJECTILE SLOWS DOWN IN ONE SLICE OF THE TARGET

		XX2=IFIX(DTHICK+0.5)
		DXX2=1
		IF(XX2.GT.500) THEN
			DXX2=XX2/500
			XX2=500
		ENDIF
		DO II=1,XX2
			STOP=STPW(EPT,ZPROJ,APROJ,NATOMS(1),
	1			ZARR(1,1),AARR(1,1),ANARR(1,1))*FACPT
			EPT=EPT-STOP*DXX2
			IF(EPT.LE.EMIN) THEN
				WRITE(6,'(''  Projectile stops in the target'')')
				GOTO 1001
			ENDIF
		ENDDO
		ETOT=EPT+QVALO

C		    KINEMATICS

		CALL CINEMA(MASS1,MASS2,MASS3,MASS4,QVALO,EPT,THM,
	1		ENED1,THU1,ENEU1,ENED2,THU2,ENEU2,THCMD1,THCMD2)

		IF(ENED1.LE.0 .AND. ENED2.LE.0) THEN
		   THL=THM*DEGRAD
		   WRITE(6,'(''  No light particle at '',F8.2,''  DEG.'')')THL
		   GOTO 1001
		ENDIF 

		NSOLU=1
		IF(ENED1.GT.0 .AND. ENED2.GT.0) THEN
			WRITE(6,*) ' Kinematics with 2 solutions'
			GOTO 1001
		ENDIF

		IF(ENED1.GT.0) THEN
			ELIGHT=ENED1
			ERECO=ENEU1
			CSI=THU1
		ELSEIF(ENED1.LT.0 .OR. NSOLU.EQ.-1) THEN
			ELIGHT=ENED2
			ERECO=ENEU2
			CSI=THU2
		ENDIF
 
		COSCSI=COS(CSI)
		IF(COSCSI.LE.0.) THEN
			THL=CSI*DEGRAD
			STOP ' 2999'
		ENDIF
	
C	   LIGHT PARTICLE SLOWS DOWN IN THE TARGET

		DXCM=CTHICK(1)/THICK(1)
		ERLT=ELIGHT
		IF(TAR1.EQ.0. .OR. COS(THM).GE.0) GOTO 1019
		XX2=-TAR1/COS(THM)
		DXX2=1
		IF(XX2.GT.500) THEN
			DXX2=XX2/500
			XX2=500
		ENDIF
		DO II=1,XX2
			STOP=STPW(ERLT,ZLIGHT,ALIGHT,NATOMS(1),
	1			ZARR(1,1),AARR(1,1),ANARR(1,1))*FACLT
			ERLT=ERLT-STOP*DXX2
			IF(ERLT.LE.EMIN) THEN
			   WRITE(6,'(''  Light particle stops in target'')')
			   GOTO 1001
			ENDIF
		ENDDO

1019		CSECT=CSECTC
		IF(NSECT.GT.NORD+1) CALL INTERPOL
	1		(NSECT,NORD,(EPTO+EPT)/2,CSECT,ESECT,SECT)

		THL=THM*DEGRAD
		THR=CSI*DEGRAD
		WRITE(6,626) TAR1,EPT,ERECO,ELIGHT,CSECT,ERLT

		CHAN1=ERLT/ESCA
		CHAN2=ERLTO/ESCA
		ESPEK((CHAN1+CHAN2)/2)=10*CSECT

		CSECT=100*CSECT/(CHAN2-CHAN1)

		I1=CHAN1
		SPEK(I1)=SPEK(I1)+(I1+1-CHAN1)*CSECT
		I2=CHAN2
		SPEK(I2)=SPEK(I2)+(CHAN2-I2)*CSECT

		DO II=I1+1,I2-1
			SPEK(II)=SPEK(II)+CSECT
		ENDDO


	ENDDO

1001	IASK=0
	KLCH=1024
	IFOUT=3

	CALL WRITEDAT(IASK,FNOUT,SPEK,KLCH,IFOUT,KV)
	IL=LENGTHC(FNOUT)
	WRITE(6,*) ' Data on file   '//FNOUT(1:IL)//'/R:1'

C	FNOUT='BACKSECT.DAT'
C	CALL WRITEDAT(IASK,FNOUT,ESPEK,KLCH,IFOUT,KV)

	CALL EXIT

	END

	FUNCTION STPW(EP,IZP,IAP,NATOMS,Z,A,ATOM)

	DIMENSION Z(NATOMS),A(NATOMS),ATOM(NATOMS)

	ZP=IZP
	AP=IAP
	ASUM=0
	DO N=1,NATOMS
		ASUM= ASUM + A(N)*ATOM(N)
	ENDDO
	STPOW=0
	IF(EP.LE.0) GOTO 10

	DO N=1,NATOMS
	 	CALL ZIEGLERch(ZP,AP,Z(N),A(N),EP,STE,IFLAG,C1,C2,STNUC,STLSS)
		IF(IFLAG.NE.1) THEN
			WRITE(6,'(''  Stopping coefficients for Z='',
	1		I2,'' - A='',I2,'' not found'')') Z(N),A(N)
			STOP
			ENDIF
		STPOW=STPOW+(STE+STNUC)*ATOM(N)
	ENDDO

C	STTOT = STPOW in unita` eV/[E15Atomi/cm3]
C	STTOT =.6022*STPOW/ASUM in unita` keV/mmg/cm2

10	STPW=.6022*STPOW/ASUM

	RETURN

	END
